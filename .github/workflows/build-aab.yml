name: Aab Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # Set up JDK 17 with Gradle cache
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # Install Android SDK & Build Tools 35
    - name: Install Android SDK & Build Tools
      run: |
        sudo apt-get update
        yes | sdkmanager "platforms;android-35" "build-tools;35.0.0" "platform-tools"

    # Setup Android NDK
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1.5.0
      with:
        ndk-version: r28c

    # Grant execute permission for gradlew
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # Clear Gradle cache to avoid old Gradle/NDK issues
    - name: Clear Gradle cache
      run: rm -rf ~/.gradle/caches ~/.gradle/wrapper

    # Build AAB
    - name: Build with Gradle
      run: ./gradlew bundleRelease

    # Upload AAB
    - name: Upload AAB
      uses: actions/upload-artifact@v4
      with:
        name: engine.aab
        path: app/build/outputs/bundle/release/app-release.aab
        retention-days: 999

    # Verify 16KB Page Alignment for .so files
    - name: Verify 16KB Page Alignment
      run: |
        AAB_PATH="app/build/outputs/bundle/release/app-release.aab"
        
        TEMP_DIR=$(mktemp -d)
        unzip -qo "$AAB_PATH" "*.so" -d "$TEMP_DIR"

        for so_file in "$TEMP_DIR"/*.so; do
          echo "Checking alignment for $so_file"
          readelf -l "$so_file" | grep "p_align"
        done

        rm -rf "$TEMP_DIR"

    # Show files list
    - name: Show files list
      run: ls -R